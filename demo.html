<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Real-Time Web Threat Detection</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white transition-colors">

  <!-- Header -->
  <header class="p-4 shadow-md bg-indigo-600 dark:bg-indigo-800 text-white">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">Web Threat Detection Dashboard</h1>
      <button onclick="toggleDarkMode()" aria-label="Toggle dark mode" class="bg-white text-indigo-600 dark:bg-gray-700 dark:text-white px-3 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition">Toggle Dark Mode</button>
    </div>
  </header>

  <!-- Filters and Actions -->
  <section class="max-w-7xl mx-auto mt-6 p-4 space-y-4">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div>
        <label for="attackTypeFilter" class="block mb-1 font-semibold">Attack Type Filter:</label>
        <select id="attackTypeFilter" onchange="renderChart()" class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded px-3 py-1">
          <option value="all">All</option>
          <option value="SQL Injection">SQL Injection</option>
          <option value="XSS Attack">XSS Attack</option>
          <option value="DoS/DDoS">DoS/DDoS</option>
        </select>
      </div>
      <div>
        <label class="block mb-1 font-semibold">Date Range:</label>
        <input type="date" id="startDate" onchange="renderChart()" class="px-2 py-1 rounded bg-white dark:bg-gray-800 border dark:border-gray-700" />
        <input type="date" id="endDate" onchange="renderChart()" class="px-2 py-1 rounded bg-white dark:bg-gray-800 border dark:border-gray-700" />
      </div>
      <div class="flex items-center gap-2">
        <button onclick="exportCSV()" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700">Export CSV</button>
        <button onclick="viewCSV()" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">View CSV</button>
        <button onclick="exportPDF()" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700">Export PDF</button>
      </div>
    </div>
  </section>

  <!-- Chart Section -->
  <section class="max-w-7xl mx-auto mt-6 p-4">
    <canvas id="attackChart"></canvas>
  </section>

  <!-- Threat Logs Table -->
  <section class="max-w-7xl mx-auto mt-6 p-4">
    <h2 class="text-lg font-bold mb-2">Threat Logs</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded shadow-md">
        <thead class="bg-gray-100 dark:bg-gray-700">
          <tr>
            <th class="py-2 px-4 border">#</th>
            <th class="py-2 px-4 border">Name</th>
            <th class="py-2 px-4 border">Email</th>
            <th class="py-2 px-4 border">Message</th>
            <th class="py-2 px-4 border">Status</th>
            <th class="py-2 px-4 border">Severity</th>
            <th class="py-2 px-4 border">Timestamp</th>
            <th class="py-2 px-4 border">Action</th>
          </tr>
        </thead>
        <tbody id="logTable" class="text-sm"></tbody>
      </table>
    </div>
  </section>

  <!-- Footer -->
  <footer class="mt-10 p-4 bg-gray-100 dark:bg-gray-800 text-center text-sm text-gray-700 dark:text-gray-400">
    &copy; 2025 Web Security Scanner by Atul Kumar Pandey. All rights reserved.
  </footer>

  <!-- Scripts -->
  <script>
    const apiUrl = "http://localhost:5000/api/reports";
    let threatLogs = [];

    const fetchLogs = async () => {
      const token = localStorage.getItem("token");
      const res = await fetch(apiUrl, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      threatLogs = data;
      renderLogs();
      renderChart();
    };

    const deleteLog = async (id) => {
      const token = localStorage.getItem("token");
      await fetch(`${apiUrl}/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` }
      });
      fetchLogs();
    };

    const renderLogs = () => {
      const tbody = document.getElementById("logTable");
      tbody.innerHTML = "";
      threatLogs.forEach((log, i) => {
        tbody.innerHTML += `
          <tr class="border-t border-gray-300 dark:border-gray-600">
            <td class="py-2 px-4">${i + 1}</td>
            <td class="py-2 px-4">${escapeHTML(log.name)}</td>
            <td class="py-2 px-4">${escapeHTML(log.email)}</td>
            <td class="py-2 px-4">${escapeHTML(log.message)}</td>
            <td class="py-2 px-4">${log.status}</td>
            <td class="py-2 px-4">${log.severity}</td>
            <td class="py-2 px-4">${new Date(log.timestamp).toLocaleString()}</td>
            <td class="py-2 px-4">
              <button onclick="deleteLog(${log.id})" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 text-xs">Delete</button>
            </td>
          </tr>`;
      });
    };

    const renderChart = () => {
      const type = document.getElementById("attackTypeFilter").value;
      const startDate = new Date(document.getElementById("startDate").value);
      const endDate = new Date(document.getElementById("endDate").value);
      if (!isNaN(endDate)) endDate.setHours(23, 59, 59, 999);

      const filtered = threatLogs.filter(log => {
        const isTypeMatch = type === "all" || log.message.includes(type);
        const logDate = new Date(log.timestamp);
        const isDateMatch = (!isNaN(startDate) ? logDate >= startDate : true) &&
                            (!isNaN(endDate) ? logDate <= endDate : true);
        return isTypeMatch && isDateMatch;
      });

      const attackCounts = { "SQL Injection": 0, "XSS Attack": 0, "DoS/DDoS": 0 };
      filtered.forEach(log => {
        if (log.message.includes("SQL Injection")) attackCounts["SQL Injection"]++;
        if (log.message.includes("XSS")) attackCounts["XSS Attack"]++;
        if (log.message.includes("DoS") || log.message.includes("DDoS")) attackCounts["DoS/DDoS"]++;
      });

      const ctx = document.getElementById("attackChart").getContext("2d");
      if (window.attackChartInstance) window.attackChartInstance.destroy();

      window.attackChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(attackCounts),
          datasets: [{
            label: "Detected Threats",
            data: Object.values(attackCounts),
            backgroundColor: ["#f87171", "#60a5fa", "#fbbf24"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          },
          scales: { y: { beginAtZero: true } }
        }
      });
    };

    const exportCSV = () => {
      const rows = [["ID", "Name", "Email", "Message", "Status", "Severity", "Timestamp"]];
      const filteredLogs = getFilteredLogs();
      filteredLogs.forEach(log => {
        rows.push([log.id, log.name, log.email, log.message, log.status, log.severity, log.timestamp]);
      });
      const blob = new Blob([rows.map(r => r.join(",")).join("\n")], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "threat_logs.csv";
      link.click();
    };

    const exportPDF = () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      pdf.text("Threat Detection Chart", 10, 10);
      pdf.addImage(document.getElementById("attackChart").toDataURL(), "PNG", 10, 20, 180, 100);
      pdf.save("threat_chart.pdf");
    };

    const viewCSV = () => {
      const filteredLogs = getFilteredLogs();
      const table = filteredLogs.map(log => `${log.id} | ${log.name} | ${log.email} | ${log.message} | ${log.status} | ${log.severity} | ${log.timestamp}`).join("\n");
      alert("Filtered Logs:\n\n" + table);
    };

    const getFilteredLogs = () => {
      const type = document.getElementById("attackTypeFilter").value;
      const startDate = new Date(document.getElementById("startDate").value);
      const endDate = new Date(document.getElementById("endDate").value);
      if (!isNaN(endDate)) endDate.setHours(23, 59, 59, 999);
      return threatLogs.filter(log => {
        const isTypeMatch = type === "all" || log.message.includes(type);
        const logDate = new Date(log.timestamp);
        const isDateMatch = (!isNaN(startDate) ? logDate >= startDate : true) &&
                            (!isNaN(endDate) ? logDate <= endDate : true);
        return isTypeMatch && isDateMatch;
      });
    };

    const escapeHTML = (str) => str?.replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m])) || '';

    const toggleDarkMode = () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem("theme", document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    };

    const applySavedTheme = () => {
      const saved = localStorage.getItem("theme");
      if (saved === "light") document.documentElement.classList.remove("dark");
    };

    const initSocket = () => {
      const socket = io("http://localhost:5000");
      socket.on("new_log", (log) => {
        threatLogs.push(log);
        renderLogs();
        renderChart();
      });
    };

    window.onload = () => {
      applySavedTheme();
      fetchLogs();
      initSocket();
    };
  </script>
</body>
</html>
